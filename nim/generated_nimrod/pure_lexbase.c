/* Generated by Nimrod Compiler v0.9.3 */
/*   (c) 2014 Andreas Rumpf */
/* The generated code is subject to the original license. */
#define NIM_INTBITS 64
#include "nimbase.h"

#include <string.h>
typedef struct TNimType TNimType;
typedef struct TNimNode TNimNode;
typedef struct tbaselexer130008 tbaselexer130008;
typedef struct TNimObject TNimObject;
typedef struct tstream129037 tstream129037;
typedef N_NIMCALL_PTR(void, TY1089) (void* p, NI op);
struct TNimType {
NI size;
NU8 kind;
NU8 flags;
TNimType* base;
TNimNode* node;
void* finalizer;
TY1089 marker;
};
struct TNimNode {
NU8 kind;
NI offset;
TNimType* typ;
NCSTRING name;
NI len;
TNimNode** sons;
};
struct TNimObject {
TNimType* m_type;
};
struct tbaselexer130008 {
  TNimObject Sup;
NI Bufpos;
NCSTRING Buf;
NI Buflen;
tstream129037* Input;
NI Linenumber;
NI Sentinel;
NI Linestart;
NIM_BOOL Fileopened;
};
typedef N_NIMCALL_PTR(void, TY129038) (tstream129037* s);
typedef N_NIMCALL_PTR(NIM_BOOL, TY129042) (tstream129037* s);
typedef N_NIMCALL_PTR(void, TY129046) (tstream129037* s, NI pos);
typedef N_NIMCALL_PTR(NI, TY129051) (tstream129037* s);
typedef N_NIMCALL_PTR(NI, TY129055) (tstream129037* s, void* buffer, NI buflen);
typedef N_NIMCALL_PTR(void, TY129061) (tstream129037* s, void* buffer, NI buflen);
typedef N_NIMCALL_PTR(void, TY129067) (tstream129037* s);
struct tstream129037 {
  TNimObject Sup;
TY129038 Closeimpl;
TY129042 Atendimpl;
TY129046 Setpositionimpl;
TY129051 Getpositionimpl;
TY129055 Readdataimpl;
TY129061 Writedataimpl;
TY129067 Flushimpl;
};
N_NIMCALL(void, unsureAsgnRef)(void** dest, void* src);
N_NOCONV(void*, alloc_4201)(NI size);
N_NIMCALL(void, fillbuffer_130063)(tbaselexer130008* l);
N_NIMCALL(NI, readdata_129139)(tstream129037* s, void* buffer, NI buflen);
N_NOCONV(void*, realloc_4207)(void* p, NI newsize);
N_NIMCALL(void, skiputf8bom_131419)(tbaselexer130008* l);
N_NIMCALL(NI, fillbaselexer_130812)(tbaselexer130008* l, NI pos);
N_NOCONV(void, dealloc_4211)(void* p);
N_NIMCALL(void, close_129083)(tstream129037* s);
extern TNimType NTI1209; /* TObject */
TNimType NTI130008; /* TBaseLexer */
extern TNimType NTI105; /* int */
extern TNimType NTI144; /* cstring */
extern TNimType NTI129035; /* PStream */
extern TNimType NTI133; /* bool */

N_NIMCALL(void, fillbuffer_130063)(tbaselexer130008* l) {
	NI charsread;
	NI tocopy;
	NI s;
	NI oldbuflen;
	NI LOC5;
	charsread = 0;
	tocopy = 0;
	s = 0;
	oldbuflen = 0;
	tocopy = (NI64)((NI64)((*l).Buflen - (*l).Sentinel) - 1);
	{
		if (!(0 < tocopy)) goto LA3;
		memmove(((void*) ((*l).Buf)), ((void*) (&(*l).Buf[(NI64)((*l).Sentinel + 1)])), (NI64)(tocopy * 1));
	}
	LA3: ;
	LOC5 = 0;
	LOC5 = readdata_129139((*l).Input, ((void*) (&(*l).Buf[tocopy])), (NI64)((NI64)((*l).Sentinel + 1) * 1));
	charsread = (NI64)(LOC5 / 1);
	s = (NI64)(tocopy + charsread);
	{
		if (!(charsread < (NI64)((*l).Sentinel + 1))) goto LA8;
		(*l).Buf[s] = 0;
		(*l).Sentinel = s;
	}
	goto LA6;
	LA8: ;
	{
		s -= 1;
		while (1) {
			while (1) {
				NIM_BOOL LOC13;
				LOC13 = 0;
				LOC13 = (0 <= s);
				if (!(LOC13)) goto LA14;
				LOC13 = !((((NU8)((*l).Buf[s])) == ((NU8)(13)) || ((NU8)((*l).Buf[s])) == ((NU8)(10))));
				LA14: ;
				if (!LOC13) goto LA12;
				s -= 1;
			} LA12: ;
			{
				if (!(0 <= s)) goto LA17;
				(*l).Sentinel = s;
				goto LA11;
			}
			goto LA15;
			LA17: ;
			{
				void* LOC20;
				NI LOC21;
				oldbuflen = (*l).Buflen;
				(*l).Buflen = (NI64)((*l).Buflen * 2);
				LOC20 = 0;
				LOC20 = realloc_4207(((void*) ((*l).Buf)), (NI64)((*l).Buflen * 1));
				(*l).Buf = ((NCSTRING) (LOC20));
				LOC21 = 0;
				LOC21 = readdata_129139((*l).Input, ((void*) (&(*l).Buf[oldbuflen])), (NI64)(oldbuflen * 1));
				charsread = (NI64)(LOC21 / 1);
				{
					if (!(charsread < oldbuflen)) goto LA24;
					(*l).Buf[(NI64)(oldbuflen + charsread)] = 0;
					(*l).Sentinel = (NI64)(oldbuflen + charsread);
					goto LA11;
				}
				LA24: ;
				s = (NI64)((*l).Buflen - 1);
			}
			LA15: ;
		} LA11: ;
	}
	LA6: ;
}

N_NIMCALL(void, skiputf8bom_131419)(tbaselexer130008* l) {
	{
		NIM_BOOL LOC3;
		NIM_BOOL LOC4;
		LOC3 = 0;
		LOC4 = 0;
		LOC4 = ((NU8)((*l).Buf[0]) == (NU8)(239));
		if (!(LOC4)) goto LA5;
		LOC4 = ((NU8)((*l).Buf[1]) == (NU8)(187));
		LA5: ;
		LOC3 = LOC4;
		if (!(LOC3)) goto LA6;
		LOC3 = ((NU8)((*l).Buf[2]) == (NU8)(191));
		LA6: ;
		if (!LOC3) goto LA7;
		(*l).Bufpos += 3;
		(*l).Linestart += 3;
	}
	LA7: ;
}

N_NIMCALL(void, open_130018)(tbaselexer130008* l, tstream129037* input, NI buflen) {
	void* LOC1;
	unsureAsgnRef((void**) &(*l).Input, input);
	(*l).Bufpos = 0;
	(*l).Buflen = buflen;
	LOC1 = 0;
	LOC1 = alloc_4201((NI64)(buflen * 1));
	(*l).Buf = ((NCSTRING) (LOC1));
	(*l).Sentinel = (NI64)(buflen - 1);
	(*l).Linestart = 0;
	(*l).Linenumber = 1;
	fillbuffer_130063(l);
	skiputf8bom_131419(l);
}

N_NIMCALL(NI, fillbaselexer_130812)(tbaselexer130008* l, NI pos) {
	NI result;
	result = 0;
	{
		if (!(pos < (*l).Sentinel)) goto LA3;
		result = (NI64)(pos + 1);
	}
	goto LA1;
	LA3: ;
	{
		fillbuffer_130063(l);
		(*l).Bufpos = 0;
		result = 0;
	}
	LA1: ;
	(*l).Linestart = result;
	return result;
}

N_NIMCALL(NI, handlecr_130041)(tbaselexer130008* l, NI pos) {
	NI result;
	result = 0;
	(*l).Linenumber += 1;
	result = fillbaselexer_130812(l, pos);
	{
		if (!((NU8)((*l).Buf[result]) == (NU8)(10))) goto LA3;
		result = fillbaselexer_130812(l, result);
	}
	LA3: ;
	return result;
}

N_NIMCALL(NI, handlelf_130047)(tbaselexer130008* l, NI pos) {
	NI result;
	result = 0;
	(*l).Linenumber += 1;
	result = fillbaselexer_130812(l, pos);
	return result;
}

N_NIMCALL(NI, getcolnumber_130036)(tbaselexer130008* l, NI pos) {
	NI result;
	result = 0;
	result = (NI64)abs((NI64)(pos - (*l).Linestart));
	return result;
}

N_NIMCALL(void, close_130026)(tbaselexer130008* l) {
	dealloc_4211(((void*) ((*l).Buf)));
	close_129083((*l).Input);
}
N_NOINLINE(void, purelexbaseInit)(void) {
}

N_NOINLINE(void, purelexbaseDatInit)(void) {
static TNimNode* TMP129[8];
static TNimNode TMP32[9];
NTI130008.size = sizeof(tbaselexer130008);
NTI130008.kind = 17;
NTI130008.base = (&NTI1209);
NTI130008.flags = 2;
TMP129[0] = &TMP32[1];
TMP32[1].kind = 1;
TMP32[1].offset = offsetof(tbaselexer130008, Bufpos);
TMP32[1].typ = (&NTI105);
TMP32[1].name = "bufpos";
TMP129[1] = &TMP32[2];
TMP32[2].kind = 1;
TMP32[2].offset = offsetof(tbaselexer130008, Buf);
TMP32[2].typ = (&NTI144);
TMP32[2].name = "buf";
TMP129[2] = &TMP32[3];
TMP32[3].kind = 1;
TMP32[3].offset = offsetof(tbaselexer130008, Buflen);
TMP32[3].typ = (&NTI105);
TMP32[3].name = "bufLen";
TMP129[3] = &TMP32[4];
TMP32[4].kind = 1;
TMP32[4].offset = offsetof(tbaselexer130008, Input);
TMP32[4].typ = (&NTI129035);
TMP32[4].name = "input";
TMP129[4] = &TMP32[5];
TMP32[5].kind = 1;
TMP32[5].offset = offsetof(tbaselexer130008, Linenumber);
TMP32[5].typ = (&NTI105);
TMP32[5].name = "lineNumber";
TMP129[5] = &TMP32[6];
TMP32[6].kind = 1;
TMP32[6].offset = offsetof(tbaselexer130008, Sentinel);
TMP32[6].typ = (&NTI105);
TMP32[6].name = "sentinel";
TMP129[6] = &TMP32[7];
TMP32[7].kind = 1;
TMP32[7].offset = offsetof(tbaselexer130008, Linestart);
TMP32[7].typ = (&NTI105);
TMP32[7].name = "lineStart";
TMP129[7] = &TMP32[8];
TMP32[8].kind = 1;
TMP32[8].offset = offsetof(tbaselexer130008, Fileopened);
TMP32[8].typ = (&NTI133);
TMP32[8].name = "fileOpened";
TMP32[0].len = 8; TMP32[0].kind = 2; TMP32[0].sons = &TMP129[0];
NTI130008.node = &TMP32[0];
}

