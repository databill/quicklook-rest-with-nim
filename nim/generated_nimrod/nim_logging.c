/* Generated by Nimrod Compiler v0.9.3 */
/*   (c) 2014 Andreas Rumpf */
/* The generated code is subject to the original license. */
#define NIM_INTBITS 64
#include "nimbase.h"

#include <stdio.h>

#include <string.h>
typedef struct tlogger139024 tlogger139024;
typedef struct NimStringDesc NimStringDesc;
typedef struct TGenericSeq TGenericSeq;
typedef struct tconsolelogger139026 tconsolelogger139026;
typedef struct TY103885 TY103885;
typedef struct TNimObject TNimObject;
typedef struct TNimType TNimType;
typedef struct TNimNode TNimNode;
typedef struct tfilelogger139028 tfilelogger139028;
typedef struct trollingfilelogger139030 trollingfilelogger139030;
typedef struct TY139294 TY139294;
typedef struct tcell40090 tcell40090;
typedef struct tcellseq40106 tcellseq40106;
typedef struct tgcheap42016 tgcheap42016;
typedef struct tcellset40102 tcellset40102;
typedef struct tpagedesc40098 tpagedesc40098;
typedef struct tmemregion23010 tmemregion23010;
typedef struct tsmallchunk22238 tsmallchunk22238;
typedef struct tllchunk23004 tllchunk23004;
typedef struct tbigchunk22240 tbigchunk22240;
typedef struct tintset22215 tintset22215;
typedef struct ttrunk22211 ttrunk22211;
typedef struct tavlnode23008 tavlnode23008;
typedef struct tgcstat42014 tgcstat42014;
typedef struct tbasechunk22236 tbasechunk22236;
typedef struct tfreecell22228 tfreecell22228;
struct TGenericSeq {
NI len;
NI reserved;
};
typedef NIM_CHAR TY613[100000001];
struct NimStringDesc {
  TGenericSeq Sup;
TY613 data;
};
typedef NimStringDesc* TY139146[4];
typedef NimStringDesc* TY139016[7];
struct TY103885 {
NimStringDesc* Field0;
NimStringDesc* Field1;
NimStringDesc* Field2;
};
typedef N_NIMCALL_PTR(void, TY1089) (void* p, NI op);
struct TNimType {
NI size;
NU8 kind;
NU8 flags;
TNimType* base;
TNimNode* node;
void* finalizer;
TY1089 marker;
};
struct TNimObject {
TNimType* m_type;
};
struct tlogger139024 {
  TNimObject Sup;
NU8 Levelthreshold;
NimStringDesc* Fmtstr;
};
struct tconsolelogger139026 {
  tlogger139024 Sup;
};
struct tfilelogger139028 {
  tlogger139024 Sup;
FILE* F;
};
struct trollingfilelogger139030 {
  tfilelogger139028 Sup;
NI Maxlines;
NI Curline;
NimStringDesc* Basename;
NI Logfiles;
};
typedef NimStringDesc* TY139288[3];
struct TNimNode {
NU8 kind;
NI offset;
TNimType* typ;
NCSTRING name;
NI len;
TNimNode** sons;
};
struct tcell40090 {
NI Refcount;
TNimType* Typ;
};
struct tcellseq40106 {
NI Len;
NI Cap;
tcell40090** D;
};
struct tcellset40102 {
NI Counter;
NI Max;
tpagedesc40098* Head;
tpagedesc40098** Data;
};
typedef tsmallchunk22238* TY23022[512];
typedef ttrunk22211* ttrunkbuckets22213[256];
struct tintset22215 {
ttrunkbuckets22213 Data;
};
struct tmemregion23010 {
NI Minlargeobj;
NI Maxlargeobj;
TY23022 Freesmallchunks;
tllchunk23004* Llmem;
NI Currmem;
NI Maxmem;
NI Freemem;
NI Lastsize;
tbigchunk22240* Freechunkslist;
tintset22215 Chunkstarts;
tavlnode23008* Root;
tavlnode23008* Deleted;
tavlnode23008* Last;
tavlnode23008* Freeavlnodes;
};
struct tgcstat42014 {
NI Stackscans;
NI Cyclecollections;
NI Maxthreshold;
NI Maxstacksize;
NI Maxstackcells;
NI Cycletablesize;
NI64 Maxpause;
};
struct tgcheap42016 {
void* Stackbottom;
NI Cyclethreshold;
tcellseq40106 Zct;
tcellseq40106 Decstack;
tcellset40102 Cycleroots;
tcellseq40106 Tempstack;
NI Recgclock;
tmemregion23010 Region;
tgcstat42014 Stat;
};
typedef NI TY22218[8];
struct tpagedesc40098 {
tpagedesc40098* Next;
NI Key;
TY22218 Bits;
};
struct tbasechunk22236 {
NI Prevsize;
NI Size;
NIM_BOOL Used;
};
struct tsmallchunk22238 {
  tbasechunk22236 Sup;
tsmallchunk22238* Next;
tsmallchunk22238* Prev;
tfreecell22228* Freelist;
NI Free;
NI Acc;
NF Data;
};
struct tllchunk23004 {
NI Size;
NI Acc;
tllchunk23004* Next;
};
struct tbigchunk22240 {
  tbasechunk22236 Sup;
tbigchunk22240* Next;
tbigchunk22240* Prev;
NI Align;
NF Data;
};
struct ttrunk22211 {
ttrunk22211* Next;
NI Key;
TY22218 Bits;
};
typedef tavlnode23008* TY23014[2];
struct tavlnode23008 {
TY23014 Link;
NI Key;
NI Upperbound;
NI Level;
};
struct tfreecell22228 {
tfreecell22228* Next;
NI Zerofield;
};
struct TY139294 {
  TGenericSeq Sup;
  tlogger139024* data[SEQ_DECL_SIZE];
};
N_NIMCALL(void, log_139111)(tlogger139024* l, NU8 level, NimStringDesc* frmt, NimStringDesc** args, NI argsLen0);
N_NIMCALL(void, log_139124)(tconsolelogger139026* l, NU8 level, NimStringDesc* frmt, NimStringDesc** args, NI argsLen0);
static N_INLINE(void, writeln_116855)(FILE* f_116860, NimStringDesc** x_116863, NI x_116863Len0);
N_NIMCALL(void, write_10263)(FILE* f, NimStringDesc* s);
N_NIMCALL(NimStringDesc*, copyString)(NimStringDesc* src);
N_NIMCALL(NimStringDesc*, substitutelog_139039)(NimStringDesc* frmt);
N_NIMCALL(NimStringDesc*, rawNewString)(NI space);
N_NIMCALL(NimStringDesc*, rawNewString)(NI cap);
N_NIMCALL(NimStringDesc*, addChar)(NimStringDesc* s, NIM_CHAR c);
N_NIMCALL(NimStringDesc*, nosgetAppFilename)(void);
N_NIMCALL(NIM_CHAR, nsuToLowerChar)(NIM_CHAR c);
static N_INLINE(NIM_BOOL, eqStrings)(NimStringDesc* a, NimStringDesc* b);
N_NIMCALL(NimStringDesc*, ntgetDateStr)(void);
static N_INLINE(void, appendString)(NimStringDesc* dest, NimStringDesc* src);
N_NIMCALL(NimStringDesc*, resizeString)(NimStringDesc* dest, NI addlen);
N_NIMCALL(NimStringDesc*, ntgetClockStr)(void);
N_NIMCALL(void, nossplitFile)(NimStringDesc* path, TY103885* Result);
N_NIMCALL(NimStringDesc*, nsuFormatOpenArray)(NimStringDesc* formatstr, NimStringDesc** a, NI aLen0);
N_NIMCALL(void, log_139150)(tfilelogger139028* l, NU8 level, NimStringDesc* frmt, NimStringDesc** args, NI argsLen0);
N_NIMCALL(void, log_139266)(trollingfilelogger139030* l, NU8 level, NimStringDesc* frmt, NimStringDesc** args, NI argsLen0);
N_NIMCALL(void, nimGCvisit)(void* d, NI op);
N_NIMCALL(void, TMP83)(void* p, NI op);
N_NIMCALL(void, TMP84)(void* p, NI op);
static N_INLINE(void, nimGCunrefNoCycle)(void* p);
static N_INLINE(tcell40090*, usrtocell_43442)(void* usr);
static N_INLINE(void, rtladdzct_45002)(tcell40090* c);
N_NOINLINE(void, addzct_43418)(tcellseq40106* s, tcell40090* c);
N_NIMCALL(void*, newSeqRC1)(TNimType* typ, NI len);
N_NIMCALL(void, log_139121)(tlogger139024* l, NU8 level, NimStringDesc* frmt, NimStringDesc** args, NI argsLen0);
STRING_LITERAL(TMP49, "\012", 1);
STRING_LITERAL(TMP50, "DEBUG", 5);
STRING_LITERAL(TMP51, "INFO", 4);
STRING_LITERAL(TMP52, "WARN", 4);
STRING_LITERAL(TMP53, "ERROR", 5);
STRING_LITERAL(TMP54, "FATAL", 5);
STRING_LITERAL(TMP55, "NONE", 4);
NIM_CONST TY139016 levelnames_139015 = {((NimStringDesc*) &TMP50),
((NimStringDesc*) &TMP50),
((NimStringDesc*) &TMP51),
((NimStringDesc*) &TMP52),
((NimStringDesc*) &TMP53),
((NimStringDesc*) &TMP54),
((NimStringDesc*) &TMP55)}
;
STRING_LITERAL(TMP56, " ", 1);
STRING_LITERAL(TMP57, "", 0);
STRING_LITERAL(TMP61, "date", 4);
STRING_LITERAL(TMP62, "time", 4);
STRING_LITERAL(TMP63, "app", 3);
STRING_LITERAL(TMP64, "appdir", 6);
STRING_LITERAL(TMP65, "appname", 7);
NU8 level_139293;
TY139294* handlers_139316;
extern TNimType NTI1209; /* TObject */
TNimType NTI139024; /* TLogger */
TNimType NTI139006; /* TLevel */
extern TNimType NTI142; /* string */
TNimType NTI139113; /* ref TLogger */
TNimType NTI139294; /* seq[ref TLogger] */
extern tgcheap42016 gch_42044;
TNimType NTI139028; /* TFileLogger */
extern TNimType NTI9804; /* TFile */
TNimType NTI139030; /* TRollingFileLogger */
extern TNimType NTI105; /* int */
TNimType NTI139026; /* TConsoleLogger */

N_NIMCALL(void, log_139111)(tlogger139024* l, NU8 level, NimStringDesc* frmt, NimStringDesc** args, NI argsLen0) {
}

static N_INLINE(void, writeln_116855)(FILE* f_116860, NimStringDesc** x_116863, NI x_116863Len0) {
	NimStringDesc* i_116875;
	NI i_116881;
	i_116875 = 0;
	i_116881 = 0;
	while (1) {
		if (!(i_116881 < x_116863Len0)) goto LA1;
		i_116875 = x_116863[i_116881];
		write_10263(f_116860, i_116875);
		i_116881 += 1;
	} LA1: ;
	write_10263(f_116860, ((NimStringDesc*) &TMP49));
}

static N_INLINE(NIM_BOOL, eqStrings)(NimStringDesc* a, NimStringDesc* b) {
	NIM_BOOL result;
	NIM_BOOL LOC11;
	int LOC13;
	result = 0;
	{
		if (!(a == b)) goto LA3;
		result = NIM_TRUE;
		goto BeforeRet;
	}
	LA3: ;
	{
		NIM_BOOL LOC7;
		LOC7 = 0;
		LOC7 = (a == NIM_NIL);
		if (LOC7) goto LA8;
		LOC7 = (b == NIM_NIL);
		LA8: ;
		if (!LOC7) goto LA9;
		result = NIM_FALSE;
		goto BeforeRet;
	}
	LA9: ;
	LOC11 = 0;
	LOC11 = ((*a).Sup.len == (*b).Sup.len);
	if (!(LOC11)) goto LA12;
	LOC13 = 0;
	LOC13 = memcmp(((NCSTRING) ((*a).data)), ((NCSTRING) ((*b).data)), (NI64)((*a).Sup.len * 1));
	LOC11 = (LOC13 == ((NI32) 0));
	LA12: ;
	result = LOC11;
	goto BeforeRet;
	BeforeRet: ;
	return result;
}

static N_INLINE(void, appendString)(NimStringDesc* dest, NimStringDesc* src) {
	memcpy(((NCSTRING) (&(*dest).data[((*dest).Sup.len)- 0])), ((NCSTRING) ((*src).data)), (NI64)((*src).Sup.len + 1));
	(*dest).Sup.len += (*src).Sup.len;
}

N_NIMCALL(NimStringDesc*, substitutelog_139039)(NimStringDesc* frmt) {
	NimStringDesc* result;
	NI i;
	result = 0;
	result = rawNewString((NI64)(frmt->Sup.len + 20));
	i = 0;
	while (1) {
		if (!(i < frmt->Sup.len)) goto LA1;
		{
			if (!!(((NU8)(frmt->data[i]) == (NU8)(36)))) goto LA4;
			result = addChar(result, frmt->data[i]);
			i += 1;
		}
		goto LA2;
		LA4: ;
		{
			NimStringDesc* v;
			NimStringDesc* app;
			i += 1;
			v = copyString(((NimStringDesc*) &TMP57));
			app = nosgetAppFilename();
			while (1) {
				NIM_CHAR LOC8;
				if (!(((NU8)(frmt->data[i])) >= ((NU8)(97)) && ((NU8)(frmt->data[i])) <= ((NU8)(122)) || ((NU8)(frmt->data[i])) >= ((NU8)(65)) && ((NU8)(frmt->data[i])) <= ((NU8)(90)) || ((NU8)(frmt->data[i])) >= ((NU8)(48)) && ((NU8)(frmt->data[i])) <= ((NU8)(57)) || ((NU8)(frmt->data[i])) == ((NU8)(95)))) goto LA7;
				LOC8 = 0;
				LOC8 = nsuToLowerChar(frmt->data[i]);
				v = addChar(v, LOC8);
				i += 1;
			} LA7: ;
			if (eqStrings(v, ((NimStringDesc*) &TMP61))) goto LA9;
			if (eqStrings(v, ((NimStringDesc*) &TMP62))) goto LA10;
			if (eqStrings(v, ((NimStringDesc*) &TMP63))) goto LA11;
			if (eqStrings(v, ((NimStringDesc*) &TMP64))) goto LA12;
			if (eqStrings(v, ((NimStringDesc*) &TMP65))) goto LA13;
			goto LA14;
			LA9: ;
			{
				NimStringDesc* LOC17;
				LOC17 = 0;
				LOC17 = ntgetDateStr();
				result = resizeString(result, LOC17->Sup.len + 0);
appendString(result, LOC17);
			}
			goto LA15;
			LA10: ;
			{
				NimStringDesc* LOC19;
				LOC19 = 0;
				LOC19 = ntgetClockStr();
				result = resizeString(result, LOC19->Sup.len + 0);
appendString(result, LOC19);
			}
			goto LA15;
			LA11: ;
			{
				result = resizeString(result, app->Sup.len + 0);
appendString(result, app);
			}
			goto LA15;
			LA12: ;
			{
				TY103885 LOC22;
				memset((void*)&LOC22, 0, sizeof(LOC22));
				nossplitFile(app, &LOC22);
				result = resizeString(result, LOC22.Field0->Sup.len + 0);
appendString(result, LOC22.Field0);
			}
			goto LA15;
			LA13: ;
			{
				TY103885 LOC24;
				memset((void*)&LOC24, 0, sizeof(LOC24));
				nossplitFile(app, &LOC24);
				result = resizeString(result, LOC24.Field1->Sup.len + 0);
appendString(result, LOC24.Field1);
			}
			goto LA15;
			LA14: ;
			{
			}
			LA15: ;
		}
		LA2: ;
	} LA1: ;
	return result;
}

N_NIMCALL(void, log_139124)(tconsolelogger139026* l, NU8 level, NimStringDesc* frmt, NimStringDesc** args, NI argsLen0) {
	TY139146 LOC1;
	memset((void*)LOC1, 0, sizeof(LOC1));
	LOC1[0] = copyString(levelnames_139015[(level)- 0]);
	LOC1[1] = copyString(((NimStringDesc*) &TMP56));
	LOC1[2] = substitutelog_139039((*l).Sup.Fmtstr);
	LOC1[3] = nsuFormatOpenArray(frmt, args, argsLen0);
	writeln_116855(stdout, LOC1, 4);
}

N_NIMCALL(void, log_139150)(tfilelogger139028* l, NU8 level, NimStringDesc* frmt, NimStringDesc** args, NI argsLen0) {
	TY139146 LOC1;
	memset((void*)LOC1, 0, sizeof(LOC1));
	LOC1[0] = copyString(levelnames_139015[(level)- 0]);
	LOC1[1] = copyString(((NimStringDesc*) &TMP56));
	LOC1[2] = substitutelog_139039((*l).Sup.Fmtstr);
	LOC1[3] = nsuFormatOpenArray(frmt, args, argsLen0);
	writeln_116855((*l).F, LOC1, 4);
}

N_NIMCALL(void, log_139266)(trollingfilelogger139030* l, NU8 level, NimStringDesc* frmt, NimStringDesc** args, NI argsLen0) {
	TY139288 LOC1;
	memset((void*)LOC1, 0, sizeof(LOC1));
	LOC1[0] = copyString(levelnames_139015[(level)- 0]);
	LOC1[1] = copyString(((NimStringDesc*) &TMP56));
	LOC1[2] = nsuFormatOpenArray(frmt, args, argsLen0);
	writeln_116855((*l).Sup.F, LOC1, 3);
}
N_NIMCALL(void, TMP83)(void* p, NI op) {
	tlogger139024* a;
	a = (tlogger139024*)p;
	nimGCvisit((void*)(*a).Fmtstr, op);
}
N_NIMCALL(void, TMP84)(void* p, NI op) {
	TY139294* a;
	NI LOC1;
	a = (TY139294*)p;
	LOC1 = 0;
	for (LOC1 = 0; LOC1 < a->Sup.len; LOC1++) {
	nimGCvisit((void*)a->data[LOC1], op);
	}
}

static N_INLINE(tcell40090*, usrtocell_43442)(void* usr) {
	tcell40090* result;
	result = 0;
	result = ((tcell40090*) ((NI)((NU64)(((NI) (usr))) - (NU64)(((NI)sizeof(tcell40090))))));
	return result;
}

static N_INLINE(void, rtladdzct_45002)(tcell40090* c) {
	addzct_43418(&gch_42044.Zct, c);
}

static N_INLINE(void, nimGCunrefNoCycle)(void* p) {
	tcell40090* c;
	c = usrtocell_43442(p);
	{
		(*c).Refcount -= 8;
		if (!((NU64)((*c).Refcount) < (NU64)(8))) goto LA3;
		rtladdzct_45002(c);
	}
	LA3: ;
}

N_NIMCALL(void, logloop_139319)(NU8 level, NimStringDesc* frmt, NimStringDesc** args, NI argsLen0) {
	tlogger139024* logger_139366;
	NI i_139376;
	logger_139366 = 0;
	i_139376 = 0;
	while (1) {
		if (!(i_139376 < handlers_139316->Sup.len)) goto LA1;
		logger_139366 = handlers_139316->data[i_139376];
		{
			if (!((*logger_139366).Levelthreshold <= level)) goto LA4;
			log_139121(logger_139366, level, frmt, args, argsLen0);
		}
		LA4: ;
		i_139376 += 1;
	} LA1: ;
}
N_NOINLINE(void, nimloggingInit)(void) {
	level_139293 = ((NU8) 0);
	if (handlers_139316) nimGCunrefNoCycle(handlers_139316);
	handlers_139316 = (TY139294*) newSeqRC1((&NTI139294), 0);
}

N_NOINLINE(void, nimloggingDatInit)(void) {
static TNimNode* TMP79[2];
static TNimNode* TMP80[7];
NI TMP82;
static char* NIM_CONST TMP81[7] = {
"lvlAll", 
"lvlDebug", 
"lvlInfo", 
"lvlWarn", 
"lvlError", 
"lvlFatal", 
"lvlNone"};
static TNimNode* TMP769[4];
static TNimNode TMP42[18];
NTI139024.size = sizeof(tlogger139024);
NTI139024.kind = 17;
NTI139024.base = (&NTI1209);
NTI139024.flags = 2;
TMP79[0] = &TMP42[1];
NTI139006.size = sizeof(NU8);
NTI139006.kind = 14;
NTI139006.base = 0;
NTI139006.flags = 3;
for (TMP82 = 0; TMP82 < 7; TMP82++) {
TMP42[TMP82+2].kind = 1;
TMP42[TMP82+2].offset = TMP82;
TMP42[TMP82+2].name = TMP81[TMP82];
TMP80[TMP82] = &TMP42[TMP82+2];
}
TMP42[9].len = 7; TMP42[9].kind = 2; TMP42[9].sons = &TMP80[0];
NTI139006.node = &TMP42[9];
TMP42[1].kind = 1;
TMP42[1].offset = offsetof(tlogger139024, Levelthreshold);
TMP42[1].typ = (&NTI139006);
TMP42[1].name = "levelThreshold";
TMP79[1] = &TMP42[10];
TMP42[10].kind = 1;
TMP42[10].offset = offsetof(tlogger139024, Fmtstr);
TMP42[10].typ = (&NTI142);
TMP42[10].name = "fmtStr";
TMP42[0].len = 2; TMP42[0].kind = 2; TMP42[0].sons = &TMP79[0];
NTI139024.node = &TMP42[0];
NTI139113.size = sizeof(tlogger139024*);
NTI139113.kind = 22;
NTI139113.base = (&NTI139024);
NTI139113.flags = 2;
NTI139113.marker = TMP83;
NTI139294.size = sizeof(TY139294*);
NTI139294.kind = 24;
NTI139294.base = (&NTI139113);
NTI139294.flags = 2;
NTI139294.marker = TMP84;
NTI139028.size = sizeof(tfilelogger139028);
NTI139028.kind = 17;
NTI139028.base = (&NTI139024);
NTI139028.flags = 2;
TMP42[11].kind = 1;
TMP42[11].offset = offsetof(tfilelogger139028, F);
TMP42[11].typ = (&NTI9804);
TMP42[11].name = "f";
NTI139028.node = &TMP42[11];
NTI139030.size = sizeof(trollingfilelogger139030);
NTI139030.kind = 17;
NTI139030.base = (&NTI139028);
NTI139030.flags = 2;
TMP769[0] = &TMP42[13];
TMP42[13].kind = 1;
TMP42[13].offset = offsetof(trollingfilelogger139030, Maxlines);
TMP42[13].typ = (&NTI105);
TMP42[13].name = "maxLines";
TMP769[1] = &TMP42[14];
TMP42[14].kind = 1;
TMP42[14].offset = offsetof(trollingfilelogger139030, Curline);
TMP42[14].typ = (&NTI105);
TMP42[14].name = "curLine";
TMP769[2] = &TMP42[15];
TMP42[15].kind = 1;
TMP42[15].offset = offsetof(trollingfilelogger139030, Basename);
TMP42[15].typ = (&NTI142);
TMP42[15].name = "baseName";
TMP769[3] = &TMP42[16];
TMP42[16].kind = 1;
TMP42[16].offset = offsetof(trollingfilelogger139030, Logfiles);
TMP42[16].typ = (&NTI105);
TMP42[16].name = "logFiles";
TMP42[12].len = 4; TMP42[12].kind = 2; TMP42[12].sons = &TMP769[0];
NTI139030.node = &TMP42[12];
NTI139026.size = sizeof(tconsolelogger139026);
NTI139026.kind = 17;
NTI139026.base = (&NTI139024);
NTI139026.flags = 2;
TMP42[17].len = 0; TMP42[17].kind = 2;
NTI139026.node = &TMP42[17];
}

